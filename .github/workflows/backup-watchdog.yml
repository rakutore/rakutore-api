name: daily-backup-watchdog

on:
  schedule:
    - cron: '30 16 * * *'   # UTC 16:30 = JST 01:30。backupの後ろに合わせてね
  workflow_dispatch: {}

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      issues: write

    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // 最新の backup 実行を取得
            const runsRes = await github.rest.actions.listWorkflowRuns({
              owner, repo,
              workflow_id: 'backup.yml',   // ← 実ファイル名に合わせてね
              per_page: 1
            });
            const runs = runsRes.data.workflow_runs || [];
            if (runs.length === 0) {
              core.setFailed('No backup runs found');
              return;
            }

            const run = runs[0];

            // まだ実行中ならスキップ（誤検知防止）
            if (run.status !== 'completed') {
              core.info(`Latest backup is ${run.status}. Skipping check.`);
              return;
            }

            const ok = (run.conclusion === 'success');
            const today = new Date().toISOString().slice(0,10);
            const title = `Backup watchdog: ${today}`;

            // 同名Issueの有無を検索（REST配下で呼ぶのが正解）
            const found = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} in:title "${title}" is:issue`
            });
            const existing = found.data.items?.[0];

            if (ok) {
              if (existing) {
                await github.rest.issues.update({
                  owner, repo, issue_number: existing.number, state: 'closed'
                });
                core.info('Backup healthy. Closed existing alert.');
              } else {
                core.info('Backup healthy. Nothing to do.');
              }
            } else {
              const body = [
                `Latest backup run: ${run.html_url}`,
                `Status: **${run.status}** / Conclusion: **${run.conclusion}**`,
                '',
                'Please investigate the backup workflow logs.'
              ].join('\n');

              if (existing) {
                await github.rest.issues.update({
                  owner, repo, issue_number: existing.number, body
                });
                core.setFailed('Backup failed (updated existing alert).');
              } else {
                await github.rest.issues.create({
                  owner, repo, title, body, labels: ['ops','backup','alert']
                });
                core.setFailed('Backup failed (created alert).');
              }
            }
