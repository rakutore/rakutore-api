name: daily-backup-watchdog

on:
  schedule:
    - cron: '30 15 * * *'   # UTC 15:30 = JST 00:30。backupの実行時刻に合わせて調整
  workflow_dispatch: {}

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      issues: write

    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // 直近の backup.yml 実行を取得
            const { data } = await github.rest.actions.listWorkflowRuns({
              owner, repo,
              workflow_id: 'backup.yml',   // ← ファイル名が違うなら合わせる
              per_page: 1
            });
            if (!data.workflow_runs.length) {
              core.setFailed('No backup runs found');
              return;
            }
            const run = data.workflow_runs[0];
            const ok  = (run.conclusion === 'success');

            const today = new Date().toISOString().slice(0,10);
            const title = `Backup watchdog: ${today}`;

            // 同名Issueの有無を確認
            const q = `repo:${owner}/${repo} in:title "${title}" is:issue`;
            const found = await github.search.issuesAndPullRequests({ q });
            const existing = found.data.items[0];

            if (ok) {
              if (existing) {
                await github.rest.issues.update({
                  owner, repo, issue_number: existing.number, state: 'closed'
                });
                core.info('Backup healthy. Closed existing alert.');
              } else {
                core.info('Backup healthy. Nothing to do.');
              }
            } else {
              const body = [
                `Latest backup run: ${run.html_url}`,
                `Status: **${run.status}** / Conclusion: **${run.conclusion}**`,
                '',
                'Please investigate the backup workflow logs.'
              ].join('\n');

              if (existing) {
                await github.rest.issues.update({
                  owner, repo, issue_number: existing.number, body
                });
                core.setFailed('Backup failed (updated existing alert).');
              } else {
                await github.rest.issues.create({
                  owner, repo, title, body, labels: ['ops','backup','alert']
                });
                core.setFailed('Backup failed (created alert).');
              }
            }
