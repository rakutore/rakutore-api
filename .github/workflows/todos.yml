name: daily-todos

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      API_URL: ${{ secrets.API_URL }}
      API_KEY: ${{ secrets.API_KEY }}

    steps:
      - name: 1) 健康チェック (/healthz)
        run: |
          set -euo pipefail
          curl -fsS "$API_URL/healthz"
          echo "healthz OK"

           - name: 2) 今日のタスクを追加 (/todos)
        run: |
          set -euo pipefail
          TITLE="定期タスク $(date +'%Y-%m-%d')"

          echo "API_URL=[$API_URL]"
          echo "curl で叩く URL はこれです:"
          echo "[$API_URL/todos]"

          echo "---- curl -v 開始 ----"
          curl -v \
            -X POST "$API_URL/todos" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $API_KEY" \
            -d "{\"title\":\"$TITLE\"}" \
            -o /tmp/created.json \
            -w '\nHTTP_STATUS=%{http_code}\n'
          echo "---- curl -v 終了 ----"


      - name: 3) 結果を表示
        run: |
          echo "----- CREATED -----"
          cat /tmp/created.json
