name: daily-todos

on:
  schedule:
    - cron: '0 0 * * *'   # UTC 0:00 = JST 9:00 実行
  workflow_dispatch: {}    # 手動実行

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      API_URL: ${{ secrets.API_URL }}
      API_KEY: ${{ secrets.API_KEY }}

    steps:
      - name: 1) 健康チェック (/healthz)
        run: |
          set -euo pipefail
          curl -fsS "$API_URL/healthz"
          echo "healthz OK"

        - name: 2) 今日のタスクを追加 (/api/todos)
  run: |
    set -euo pipefail
    TITLE="定期タスク $(date +'%Y-%m-%d')"

    CODE=$(curl -sS -o /tmp/created.json -w '%{http_code}' \
      -X POST "${API_URL%/}/api/todos" \
      -H "Content-Type: application/json" \
      -H "x-api-key: $API_KEY" \
      -d "{\"title\":\"$TITLE\"}" )

    echo "HTTP $CODE"
    test "$CODE" -ge 200 -a "$CODE" -lt 300


      - name: 3) 結果を表示
        run: |
          echo "----- CREATED -----"
          cat /tmp/created.json
