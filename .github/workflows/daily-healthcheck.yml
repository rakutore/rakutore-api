name: daily-healthcheck

on:
  schedule:
    - cron: '0 0 * * *'   # UTC 0:00 = JST 9:00 毎日チェック
  workflow_dispatch: {}    # 手動でも実行できる

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      API_URL: ${{ secrets.API_URL }}   # もう設定済みのやつを再利用

    steps:
      - name: 1) /healthz をチェック
        run: |
          set -euo pipefail

          echo "✅ API health check: $API_URL/healthz"

          # /healthz にアクセスしてステータスコードと本文を取得
          STATUS=$(curl -o /tmp/healthz.txt -w '%{http_code}' "$API_URL/healthz")
          echo "HTTP STATUS = $STATUS"

          echo "----- Response body -----"
          cat /tmp/healthz.txt || true
          echo "-------------------------"

          # 200〜299 以外なら失敗扱い
          test "$STATUS" -ge 200 -a "$STATUS" -lt 300
