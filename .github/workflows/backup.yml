name: backup

on:
  schedule:
    - cron: '0 16 * * *'   # UTC16:00 = JST 01:00
  workflow_dispatch: {}

jobs:
  dump:
    runs-on: ubuntu-latest

    steps:
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client

      - name: Check connectivity (SSL)
        env:
          PGPASSWORD: ${{ secrets.PG_DB_PASSWORD }}   # Supabase の「Database password」（そのまま生の文字列）
        run: |
          set -e
          psql "host=aws-1-ap-northeast-1.pooler.supabase.com port=5432 dbname=postgres user=postgres.josqeoejhhimsdryxtnv sslmode=require" \
            -Atc 'select current_user, now()'

      - name: Dump database (SSL)
        env:
          PGPASSWORD: ${{ secrets.PG_DB_PASSWORD }}
        run: |
          set -e
          pg_dump "host=aws-1-ap-northeast-1.pooler.supabase.com port=5432 dbname=postgres user=postgres.josqeoejhhimsdryxtnv sslmode=require" \
            -Fc -f backup.dump

      - name: Upload artifact (7days)
        uses: actions/upload-artifact@v4
        with:
          name: pg-backup
          path: backup.dump
          retention-days: 7
